name: Supply Chain Security Pipeline

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/supply-chain-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  supply-chain:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Install Required Tools
    # ------------------------------------------------------------
    - name: Install Trivy
      uses: aquasecurity/setup-trivy@v0.2.0

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.5.0

    - name: Install Rekor CLI
      run: |
        curl -sSL https://github.com/sigstore/rekor/releases/latest/download/rekor-cli-linux-amd64 -o rekor-cli
        chmod +x rekor-cli
        sudo mv rekor-cli /usr/local/bin/rekor-cli

    - name: Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # ------------------------------------------------------------
    # PHASE 1 — SECURITY SCANNING
    # ------------------------------------------------------------
    - name: Scan Source & Dependencies
      run: |
        trivy fs --severity HIGH,CRITICAL --exit-code 1 src/

    - name: Scan Dockerfile
      run: |
        trivy config --severity HIGH,CRITICAL --exit-code 1 src/docker/

    - name: Scan IaC
      run: |
        trivy config --severity HIGH,CRITICAL --exit-code 1 src/iac/

    - name: Scan Kubernetes Manifests
      run: |
        trivy config --severity HIGH,CRITICAL --exit-code 1 src/k8s/

    # ------------------------------------------------------------
    # PHASE 2 — BUILD IMAGE
    # ------------------------------------------------------------
    - name: Build and Push Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ./src
        file: ./src/docker/Dockerfile
        push: true
        platforms: linux/amd64
        tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Capture Image Digest
      run: |
        echo "DIGEST=${{ steps.build.outputs.digest }}" >> $GITHUB_ENV
        echo "IMAGE=${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}" >> $GITHUB_ENV

    # Scan built image (fail if HIGH/CRITICAL)
    - name: Scan Built Image
      run: |
        trivy image --severity HIGH,CRITICAL --exit-code 1 $IMAGE

    # ------------------------------------------------------------
    # PHASE 2 — GENERATE ATTESTATIONS
    # ------------------------------------------------------------
    - name: Create Attestations Directory
      run: mkdir -p attestations

    - name: Generate SBOM (SPDX)
      run: |
        syft $IMAGE -o spdx-json=attestations/sbom.json

    - name: Generate Source Vulnerability Attestation
      run: |
        trivy fs --format cosign-vuln src/ > attestations/vuln-source.json

    - name: Generate IaC Vulnerability Attestation
      run: |
        trivy config --format cosign-vuln src/iac/ > attestations/vuln-iac.json

    - name: Generate Image Vulnerability Attestation
      run: |
        trivy image --format cosign-vuln $IMAGE > attestations/vuln-image.json

    # ------------------------------------------------------------
    # PHASE 3 — SIGN IMAGE (KEYLESS OIDC)
    # ------------------------------------------------------------
    - name: Sign Image
      env:
        COSIGN_EXPERIMENTAL: "true"
      run: |
        cosign sign --yes $IMAGE

    # ------------------------------------------------------------
    # PHASE 3 — ATTACH ATTESTATIONS
    # ------------------------------------------------------------
    - name: Attach SBOM Attestation
      run: |
        cosign attest --yes \
          --type spdxjson \
          --predicate attestations/sbom.json \
          $IMAGE

    - name: Attach Vulnerability Attestation (Source)
      run: |
        cosign attest --yes \
          --type vuln \
          --predicate attestations/vuln-source.json \
          $IMAGE

    - name: Attach Vulnerability Attestation (IaC)
      run: |
        cosign attest --yes \
          --type vuln \
          --predicate attestations/vuln-iac.json \
          $IMAGE

    - name: Attach Vulnerability Attestation (Image)
      run: |
        cosign attest --yes \
          --type vuln \
          --predicate attestations/vuln-image.json \
          $IMAGE

    # ------------------------------------------------------------
    # PHASE 3 — VERIFICATION
    # ------------------------------------------------------------
    - name: Verify Image Signature
      run: |
        cosign verify \
          --certificate-identity-regexp=".*" \
          --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
          $IMAGE

    - name: Verify SBOM Attestation
      run: |
        cosign verify-attestation \
          --type spdxjson \
          --certificate-identity-regexp=".*" \
          --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
          $IMAGE

    - name: Verify Vulnerability Attestations
      run: |
        cosign verify-attestation \
          --type vuln \
          --certificate-identity-regexp=".*" \
          --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
          $IMAGE

    # ------------------------------------------------------------
    # REKOR TRANSPARENCY LOG CHECK
    # ------------------------------------------------------------
    - name: Verify Rekor Entries
      run: |
        HASH=$(echo $DIGEST | cut -d: -f2)
        COUNT=$(rekor-cli search --sha $HASH | wc -l)
        echo "Rekor entries found: $COUNT"
        if [ "$COUNT" -lt 5 ]; then
          echo "Expected at least 5 Rekor entries"
          exit 1
        fi

    # ------------------------------------------------------------
    # SUCCESS MESSAGE
    # ------------------------------------------------------------
    - name: Success Summary
      run: |
        echo "Pipeline completed successfully."
        echo "Published image:"
        echo "$IMAGE"
