name: supply-chain-lab

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Install Base Tools
    # ------------------------------------------------------------
    - name: Install Task
      uses: go-task/setup-task@v1
      with:
        version: 3.x

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install Cosign
      uses: sigstore/cosign-installer@v4.0.0
      with:
        cosign-release: "v3.0.4"

    - name: Install Rekor CLI
      run: |
        set -e
        REKOR_VERSION="v1.3.6"
        curl -sSfL https://github.com/sigstore/rekor/releases/download/${REKOR_VERSION}/rekor-cli-linux-amd64 -o rekor-cli
        chmod +x rekor-cli
        sudo mv rekor-cli /usr/local/bin/rekor-cli

    - name: Verify Tools
      run: |
        task --version
        docker --version
        cosign version
        rekor-cli version
        jq --version
        openssl version

    # ------------------------------------------------------------
    # Phase 1 — Security Scanning
    # ------------------------------------------------------------
    - name: Build scan tools
      run: task build-tools

    - name: Run all security scans
      run: task scan-all

    - name: Build application
      run: task build

    - name: Build container image (local)
      run: task build-image

    # ------------------------------------------------------------
    # Phase 2 — Attestations (Provenance + SBOM + Vuln)
    # ------------------------------------------------------------
    - name: Create docker-container buildx builder
      run: |
        docker buildx create --name container-builder --driver docker-container --use
        docker buildx inspect --bootstrap

    - name: Build image with attestations
      run: |
        task build-image-with-attestation
        test -f out/provenance.json
        test -f out/sbom.spdx.json

    - name: Prepare attestations directory
      run: mkdir -p attestations

    - name: Extract provenance predicate
      run: |
        jq .predicate out/provenance.json > attestations/provenance.json
        test -s attestations/provenance.json

    - name: Extract SBOM predicate
      run: |
        jq .predicate out/sbom.spdx.json > attestations/sbom.json
        test -s attestations/sbom.json

    - name: Generate vulnerability predicates
      run: |
        task exec -- trivy fs --format cosign-vuln src/ > attestations/vuln-source.json
        task exec -- trivy config --format cosign-vuln src/iac/ > attestations/vuln-iac.json
        task exec -- trivy image --format cosign-vuln supply-chain-app:latest > attestations/vuln-image.json

    - name: Validate all attestations
      run: task validate:all-attestations

    # ------------------------------------------------------------
    # Phase 3 — Push + Sign + Verify
    # ------------------------------------------------------------
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push image and capture digest
      id: push
      run: |
        set -e

        OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_REPO="ghcr.io/${OWNER}/supply-chain-app"
        TAG="${{ github.sha }}"

        docker tag supply-chain-app:latest "${IMAGE_REPO}:${TAG}"
        docker push "${IMAGE_REPO}:${TAG}" | tee push.txt

        DIGEST=$(grep -m1 digest: push.txt | awk '{print $3}')
        IMAGE="${IMAGE_REPO}@${DIGEST}"

        echo "DIGEST=${DIGEST}" >> $GITHUB_ENV
        echo "IMAGE=${IMAGE}" >> $GITHUB_ENV

        echo "Image pushed: ${IMAGE}"

    # ---------------- IMAGE SIGN ----------------
    - name: Sign container image (keyless)
      env:
        COSIGN_EXPERIMENTAL: "1"
      run: |
        cosign sign --yes --tlog-upload=true "${IMAGE}"

    # ---------------- VERIFY IMAGE (NO HANG) ----------------
    - name: Verify image signature (CI-safe)
      env:
        COSIGN_EXPERIMENTAL: "1"
      run: |
        cosign verify \
          --experimental-oci11 \
          --insecure-ignore-tlog \
          --certificate-identity-regexp=".*" \
          --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
          "${IMAGE}"

    # ---------------- SIGN ATTESTATIONS ----------------
    - name: Sign provenance attestation
      env:
        COSIGN_EXPERIMENTAL: "1"
      run: |
        cosign attest --yes \
          --type slsaprovenance \
          --predicate attestations/provenance.json \
          "${IMAGE}"

    - name: Sign SBOM attestation
      env:
        COSIGN_EXPERIMENTAL: "1"
      run: |
        cosign attest --yes \
          --type spdxjson \
          --predicate attestations/sbom.json \
          "${IMAGE}"

    - name: Sign vulnerability attestations
      env:
        COSIGN_EXPERIMENTAL: "1"
      run: |
        cosign attest --yes --type vuln --predicate attestations/vuln-source.json "${IMAGE}"
        cosign attest --yes --type vuln --predicate attestations/vuln-iac.json "${IMAGE}"
        cosign attest --yes --type vuln --predicate attestations/vuln-image.json "${IMAGE}"

    # ---------------- VERIFY ATTESTATIONS (NO HANG) ----------------
    - name: Verify attestations (CI-safe)
      env:
        COSIGN_EXPERIMENTAL: "1"
      run: |
        for TYPE in slsaprovenance spdxjson vuln; do
          cosign verify-attestation \
            --experimental-oci11 \
            --insecure-ignore-tlog \
            --type "${TYPE}" \
            --certificate-identity-regexp=".*" \
            --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
            "${IMAGE}"
        done

    # ---------------- REKOR CHECK ----------------
    - name: Verify Rekor entries (retry)
      run: |
        HASH=$(echo "${DIGEST}" | cut -d: -f2)

        for i in {1..10}; do
          OUT=$(rekor-cli search --sha "${HASH}" || true)
          if echo "$OUT" | grep -q .; then
            echo "$OUT"
            exit 0
          fi
          echo "Waiting for Rekor... attempt $i"
          sleep 5
        done

        echo "No Rekor entries found."
        exit 1

    # ---------------- LAB VALIDATION ----------------
    - name: Phase 3 Validation (Lab)
      run: task validate:phase3
